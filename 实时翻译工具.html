<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能翻译工具</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
    
    <style>
        /* 基础样式 */
        .translation-result { min-height: 120px; white-space: pre-wrap; word-break: break-word; }
        
        /* 加载动画 */
        .loader {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spinner 0.6s linear infinite;
        }
        @keyframes spinner { to { transform: rotate(360deg); } }
        
        /* 结果区域的加载动画 */
        .result-loader {
            border: 2px solid rgba(156, 163, 175, 0.3);
            border-top-color: #6b7280;
            border-radius: 50%;
            animation: spinner 0.6s linear infinite;
        }
        
        /* 语言变化动画 */
        @keyframes langChange {
            0% { opacity: 0.5; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        .lang-update { animation: langChange 0.3s ease-out; }
        
        /* 错误提示样式 */
        .error-highlight {
            border-color: #EF4444 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1) !important;
        }
        
        /* 按钮悬停效果增强 */
        .btn-hover-effect {
            transition: all 0.2s ease;
        }
        .btn-hover-effect:hover {
            transform: translateY(-1px);
        }
        .btn-hover-effect:active {
            transform: translateY(0);
        }
        
        /* 语言选择器样式 */
        .lang-selector {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .lang-selector:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- 标题区域 -->
        <header class="text-center mb-5">
            <h1 class="text-2xl font-bold text-gray-800 mb-1">
                <i class="fa fa-language text-blue-500 mr-2"></i>智能翻译工具
            </h1>
            <p class="text-gray-600 text-sm">精准识别，高效翻译</p>
        </header>
        
        <!-- 翻译主体卡片 -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <!-- 输入区域 -->
            <div class="p-6 border-b border-gray-100">
                <div class="flex justify-between items-center mb-2">
                    <label for="sourceText" class="block text-sm font-medium text-gray-700">输入文本：</label>
                    <div class="flex items-center space-x-2 text-sm">
                        <span id="langFrom" class="font-medium text-gray-700 lang-selector">检测语言</span>
                        <button id="swapLangBtn" class="text-blue-400 hover:text-blue-600 p-1 rounded-full hover:bg-blue-50 transition-colors">
                            <i class="fa fa-exchange"></i>
                        </button>
                        <span id="langTo" class="font-medium text-gray-700 lang-selector">中文</span>
                    </div>
                </div>
                <textarea 
                    id="sourceText" 
                    class="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-500 resize-none" 
                    rows="6" 
                    placeholder="输入文本内容..."
                ></textarea>
                <!-- 功能按钮行 -->
                <div class="flex justify-between items-center mt-3">
                    <span id="charCount" class="text-gray-500 text-sm flex items-center">
                        <i class="fa fa-file-text-o mr-1.5"></i>0 字符
                    </span>
                    
                    <!-- 翻译按钮 -->
                    <button id="translateBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full shadow transition-colors flex items-center mx-2 btn-hover-effect">
                        <i class="fa fa-language mr-1.5"></i>
                        <span>开始翻译</span>
                        <div id="loader" class="hidden ml-1.5 w-3.5 h-3.5 loader"></div>
                    </button>
                    
                    <button id="clearBtn" class="text-gray-500 hover:text-gray-700 px-2 py-1 flex items-center btn-hover-effect">
                        <i class="fa fa-trash-o mr-1.5"></i> 清空
                    </button>
                </div>
            </div>
            
            <!-- 结果区域 -->
            <div class="p-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">翻译结果：</label>
                <div id="resultText" class="w-full p-3 bg-gray-50 rounded-lg translation-result">
                    <div class="text-gray-400 text-center py-5"><i class="fa fa-info-circle mr-1.5"></i> 翻译结果将显示在这里</div>
                </div>
                <button id="copyBtn" class="mt-3 text-blue-500 hover:text-blue-600 text-sm flex items-center btn-hover-effect">
                    <i class="fa fa-copy mr-1.5"></i> 复制结果
                </button>
            </div>
        </div>
        
        <!-- 错误提示区域 -->
        <div id="errorPanel" class="mt-4 bg-red-50 border border-red-100 rounded-lg p-4 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-exclamation-circle text-red-500 text-lg"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">操作提示</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p id="errorMessage">翻译服务暂时不可用，请稍后再试</p>
                    </div>
                    <div class="mt-3">
                        <button id="retryBtn" class="inline-flex items-center px-3 py-1.5 border border-red-300 shadow-sm text-xs font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 btn-hover-effect">
                            <i class="fa fa-refresh mr-1.5"></i> 重试
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 帮助信息 -->
        <div class="mt-6 bg-white rounded-xl p-4 shadow-sm">
            <h3 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">
                <i class="fa fa-question-circle text-blue-500 mr-1.5"></i>使用帮助
            </h3>
            <ul class="text-sm text-gray-600 space-y-1">
                <li class="flex items-start">
                    <i class="fa fa-circle text-xs text-blue-500 mt-1.5 mr-2"></i>
                    <span>支持识别并翻译中文、英文、日语、韩语、俄语、法语、西班牙语等多种语言</span>
                </li>
                <li class="flex items-start">
                    <i class="fa fa-circle text-xs text-blue-500 mt-1.5 mr-2"></i>
                    <span>点击语言名称可手动选择翻译方向，点击交换按钮可快速切换源语言和目标语言</span>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- 语言选择面板 -->
    <div id="langSelectorPanel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-5 transform transition-all">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">选择语言</h3>
            <div class="grid grid-cols-3 gap-2 max-h-60 overflow-y-auto pr-2">
                <!-- 语言选项将通过JS动态生成 -->
            </div>
            <div class="mt-4 pt-4 border-t border-gray-100 flex justify-end">
                <button id="closeLangSelector" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg transition-colors">
                    取消
                </button>
            </div>
        </div>
    </div>
    
    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center">
        <i class="fa fa-check-circle mr-2 text-green-400"></i>
        <span id="notificationText">操作成功</span>
    </div>

    <script>
        // 扩展语言映射配置，确保与百度翻译API语言代码一致
        const LANGUAGE_CONFIG = {
            // 百度翻译API支持的语言列表及对应名称
            // 语言代码参考: https://fanyi-api.baidu.com/doc/21
            names: {
                'auto': '自动检测',
                'zh': '中文',
                'en': '英语',
                'jp': '日语',
                'kor': '韩语',
                'ru': '俄语',
                'fra': '法语',
                'spa': '西班牙语',
                'de': '德语',
                'pt': '葡萄牙语',
                'it': '意大利语',
                'ara': '阿拉伯语',
                'hi': '印地语',
                'vie': '越南语',
                'th': '泰语',
                'nl': '荷兰语',
                'sv': '瑞典语',
                'pl': '波兰语',
                'dan': '丹麦语',
                'fin': '芬兰语',
                'cs': '捷克语',
                'ro': '罗马尼亚语',
                'hu': '匈牙利语'
            },
            // 语言检测模式 - 更精确的正则表达式
            patterns: {
                'zh': /[\u4e00-\u9fa5\u3400-\u4dbf]/,                  // 中文
                'en': /[a-zA-Z]/,                                       // 英文
                'jp': /[\u3040-\u309F\u30A0-\u30FF\u3005\u3006]/,       // 日语
                'kor': /[\uAC00-\uD7AF\u1100-\u11FF]/,                  // 韩语
                'ru': /[\u0400-\u04FF]/,                                // 俄语
                'th': /[\u0E00-\u0E7F]/,                                // 泰语
                'ara': /[\u0600-\u06FF]/,                               // 阿拉伯语
                'fra': /[àâæçéèêëîïôœùûüÿÀÂÆÇÉÈÊËÎÏÔŒÙÛÜŸ]/,            // 法语
                'spa': /[áéíóúñüÁÉÍÓÚÑÜ]/,                              // 西班牙语
                'de': /[äöüßÄÖÜ]/,                                      // 德语
                'pt': /[áéíóúãõçÁÉÍÓÚÃÕÇ]/,                             // 葡萄牙语
                'it': /[àèéìíòóùúÀÈÉÌÍÒÓÙÚ]/,                           // 意大利语
                'nl': /[ëïàâêôûĳËÏÀÂÊÔÛĲ]/,                             // 荷兰语
                'sv': /[åäöÅÄÖ]/,                                       // 瑞典语
                'pl': /[ąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/,                          // 波兰语
                'dan': /[æøåÆØÅ]/,                                      // 丹麦语
                'fin': /[äöÄÖ]/,                                         // 芬兰语
                'cs': /[áčďéěíňóřšťúůýžÁČĎÉĚÍŇÓŘŠŤÚŮÝŽ]/,               // 捷克语
                'ro': /[ăâîșțĂÂÎȘȚ]/,                                    // 罗马尼亚语
                'hu': /[áéíóöőúüűÁÉÍÓÖŐÚÜŰ]/                            // 匈牙利语
            },
            // 定义常用的翻译方向
            commonDirections: {
                'zh': 'en',     // 中文 -> 英文
                'en': 'zh',     // 英文 -> 中文
                'jp': 'zh',     // 日语 -> 中文
                'kor': 'zh',    // 韩语 -> 中文
                'ru': 'zh',     // 俄语 -> 中文
                'fra': 'zh',    // 法语 -> 中文
                'spa': 'zh',    // 西班牙语 -> 中文
                'auto': 'zh'    // 自动检测 -> 中文
            }
        };

        // DOM元素引用
        const elements = {
            sourceText: document.getElementById('sourceText'),
            resultText: document.getElementById('resultText'),
            translateBtn: document.getElementById('translateBtn'),
            clearBtn: document.getElementById('clearBtn'),
            copyBtn: document.getElementById('copyBtn'),
            charCount: document.getElementById('charCount'),
            loader: document.getElementById('loader'),
            langFrom: document.getElementById('langFrom'),
            langTo: document.getElementById('langTo'),
            swapLangBtn: document.getElementById('swapLangBtn'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notificationText'),
            errorPanel: document.getElementById('errorPanel'),
            errorMessage: document.getElementById('errorMessage'),
            retryBtn: document.getElementById('retryBtn'),
            langSelectorPanel: document.getElementById('langSelectorPanel'),
            closeLangSelector: document.getElementById('closeLangSelector')
        };

        // 翻译方向状态
        let translationState = {
            from: 'auto',
            to: 'zh'
        };

        // 当前正在选择的语言类型 ('from' 或 'to')
        let selectingLangType = null;

        // 代理服务器列表
        const PROXY_SERVERS = [
            'https://api.allorigins.win/get?url=',
            'https://cors-anywhere.herokuapp.com/',
            'https://proxy.cors.sh/'
        ];
        
        let currentProxyIndex = 0;

        // 初始化
        function initialize() {
            updateLanguageDisplay();
            createLanguageSelectorOptions();
            attachEventListeners();
        }

        // 创建语言选择器选项
        function createLanguageSelectorOptions() {
            const langGrid = elements.langSelectorPanel.querySelector('.grid');
            langGrid.innerHTML = '';
            
            // 生成语言选项
            Object.keys(LANGUAGE_CONFIG.names).forEach(langCode => {
                if (langCode === 'auto') return; // 自动检测不放在手动选择中
                
                const langName = LANGUAGE_CONFIG.names[langCode];
                const langOption = document.createElement('button');
                langOption.className = 'py-2 px-3 rounded text-left hover:bg-blue-50 text-gray-800 text-sm transition-colors';
                langOption.textContent = langName;
                langOption.dataset.langCode = langCode;
                
                langOption.addEventListener('click', () => {
                    if (selectingLangType === 'from') {
                        translationState.from = langCode;
                        // 自动调整目标语言
                        translationState.to = LANGUAGE_CONFIG.commonDirections[langCode] || 'zh';
                    } else if (selectingLangType === 'to') {
                        translationState.to = langCode;
                    }
                    
                    updateLanguageDisplay(true);
                    elements.langSelectorPanel.classList.add('hidden');
                });
                
                langGrid.appendChild(langOption);
            });
        }

        // 绑定事件监听器
        function attachEventListeners() {
            // 文本输入事件
            elements.sourceText.addEventListener('input', debounce(handleTextInput, 300));
            
            // 其他按钮事件
            elements.clearBtn.addEventListener('click', clearAllFields);
            elements.copyBtn.addEventListener('click', copyTranslationResult);
            elements.translateBtn.addEventListener('click', performTranslation);
            elements.retryBtn.addEventListener('click', performTranslation);
            elements.closeLangSelector.addEventListener('click', () => {
                elements.langSelectorPanel.classList.add('hidden');
            });
            
            // 语言选择事件
            elements.langFrom.addEventListener('click', () => {
                selectingLangType = 'from';
                elements.langSelectorPanel.classList.remove('hidden');
            });
            
            elements.langTo.addEventListener('click', () => {
                selectingLangType = 'to';
                elements.langSelectorPanel.classList.remove('hidden');
            });
            
            // 交换语言按钮
            elements.swapLangBtn.addEventListener('click', swapLanguages);
            
            // 点击外部关闭语言选择面板
            elements.langSelectorPanel.addEventListener('click', (e) => {
                if (e.target === elements.langSelectorPanel) {
                    elements.langSelectorPanel.classList.add('hidden');
                }
            });
            
            // 回车键翻译
            elements.sourceText.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    performTranslation();
                }
            });
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        // 处理文本输入 - 实时检测语言
        function handleTextInput() {
            const inputText = elements.sourceText.value.trim();
            
            elements.sourceText.classList.remove('error-highlight');
            elements.charCount.innerHTML = `<i class="fa fa-file-text-o mr-1.5"></i>${inputText.length} 字符`;
            
            // 只有当源语言是自动检测时才进行语言检测
            if (inputText.length > 0 && translationState.from === 'auto') {
                // 显示"检测中..."状态
                elements.langFrom.textContent = '检测中...';
                detectLanguage(inputText);
                updateLanguageDisplay(true);
            } else if (inputText.length === 0) {
                translationState = { from: 'auto', to: 'zh' };
                updateLanguageDisplay(true);
            }
        }

        // 改进的语言检测算法
        function detectLanguage(text) {
            // 清理文本，保留有语言特征的字符
            const cleanedText = text.replace(/[\s0-9\p{P}]/gu, '');
            
            // 如果清理后文本为空，保持自动检测
            if (cleanedText.length === 0) {
                translationState.from = 'auto';
                translationState.to = 'zh';
                return;
            }

            // 统计每种语言特征字符的出现次数
            const langScores = {};
            
            // 初始化分数对象
            Object.keys(LANGUAGE_CONFIG.patterns).forEach(lang => {
                langScores[lang] = 0;
            });
            
            // 计算每个语言的匹配分数
            Object.entries(LANGUAGE_CONFIG.patterns).forEach(([lang, pattern]) => {
                const matches = cleanedText.match(pattern);
                langScores[lang] = matches ? matches.length : 0;
            });
            
            // 找出得分最高的语言
            let highestScore = 0;
            let detectedLang = 'en'; // 默认英语
            
            Object.entries(langScores).forEach(([lang, score]) => {
                if (score > highestScore) {
                    highestScore = score;
                    detectedLang = lang;
                }
            });
            
            // 设置检测到的语言和对应的目标语言
            translationState.from = detectedLang;
            translationState.to = LANGUAGE_CONFIG.commonDirections[detectedLang] || 'zh';
        }

        // 交换源语言和目标语言
        function swapLanguages() {
            const inputText = elements.sourceText.value.trim();
            const resultText = elements.resultText.textContent.trim();
            
            // 交换语言
            const tempLang = translationState.from;
            translationState.from = translationState.to;
            translationState.to = tempLang;
            
            // 如果有内容，也交换文本
            if (inputText && resultText && !resultText.includes('翻译结果将显示在这里')) {
                elements.sourceText.value = resultText;
                elements.resultText.innerHTML = `<div class="text-gray-400 text-center py-5"><i class="fa fa-info-circle mr-1.5"></i> 翻译结果将显示在这里</div>`;
                elements.charCount.innerHTML = `<i class="fa fa-file-text-o mr-1.5"></i>${resultText.length} 字符`;
            }
            
            updateLanguageDisplay(true);
        }

        // 更新语言显示
        function updateLanguageDisplay(forceUpdate = false) {
            const fromLangName = LANGUAGE_CONFIG.names[translationState.from] || '自动检测';
            const toLangName = LANGUAGE_CONFIG.names[translationState.to] || '中文';
            
            // 更新显示
            elements.langFrom.textContent = fromLangName;
            elements.langFrom.classList.add('lang-update');
            setTimeout(() => elements.langFrom.classList.remove('lang-update'), 300);
            
            elements.langTo.textContent = toLangName;
            elements.langTo.classList.add('lang-update');
            setTimeout(() => elements.langTo.classList.remove('lang-update'), 300);
        }

        // 清空所有字段
        function clearAllFields() {
            elements.sourceText.value = '';
            elements.resultText.innerHTML = `<div class="text-gray-400 text-center py-5"><i class="fa fa-info-circle mr-1.5"></i> 翻译结果将显示在这里</div>`;
            elements.charCount.innerHTML = `<i class="fa fa-file-text-o mr-1.5"></i>0 字符`;
            elements.sourceText.classList.remove('error-highlight');
            elements.errorPanel.classList.add('hidden');
            translationState = { from: 'auto', to: 'zh' };
            updateLanguageDisplay(true);
            showNotification('已清空输入');
        }

        // 复制翻译结果
        function copyTranslationResult() {
            const resultText = elements.resultText.textContent.trim();
            if (resultText && !resultText.includes('翻译结果将显示在这里')) {
                navigator.clipboard.writeText(resultText)
                    .then(() => showNotification('结果已复制'))
                    .catch(() => showNotification('复制失败，请手动复制', false));
            }
        }

        // 显示通知
        function showNotification(message, isSuccess = true) {
            elements.notificationText.textContent = message;
            elements.notification.classList.remove('translate-y-20', 'opacity-0');
            
            if (!isSuccess) {
                elements.notification.classList.add('bg-red-600');
                elements.notification.classList.remove('bg-gray-800');
                elements.notification.querySelector('i').className = 'fa fa-exclamation-circle mr-2 text-white';
            } else {
                elements.notification.classList.remove('bg-red-600');
                elements.notification.classList.add('bg-gray-800');
                elements.notification.querySelector('i').className = 'fa fa-check-circle mr-2 text-green-400';
            }
            
            setTimeout(() => {
                elements.notification.classList.add('translate-y-20', 'opacity-0');
            }, 2000);
        }

        // 显示错误面板
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorPanel.classList.remove('hidden');
            elements.sourceText.classList.add('error-highlight');
        }

        // 隐藏错误面板
        function hideError() {
            elements.errorPanel.classList.add('hidden');
            elements.sourceText.classList.remove('error-highlight');
        }

        // 切换到下一个代理服务器
        function switchToNextProxy() {
            currentProxyIndex = (currentProxyIndex + 1) % PROXY_SERVERS.length;
            return PROXY_SERVERS[currentProxyIndex];
        }

        // 执行翻译
        function performTranslation() {
            const textToTranslate = elements.sourceText.value;
            if (!textToTranslate.trim()) {
                showNotification('请输入要翻译的文本', false);
                elements.sourceText.classList.add('error-highlight');
                return;
            }
            
            // 显示加载状态
            elements.loader.classList.remove('hidden');
            elements.translateBtn.disabled = true;
            elements.resultText.innerHTML = `<div class="text-gray-400 text-center py-5"><div class="w-5 h-5 result-loader mx-auto inline-block"></div><span class="ml-2">翻译中...</span></div>`;
            hideError();
            
            // 使用当前选择的翻译方向
            const fromLang = translationState.from;
            const toLang = translationState.to;
            
            // 百度翻译API参数
            const apiParams = {
                q: textToTranslate,
                from: fromLang,
                to: toLang,
                appid: "20250819002434150",
                salt: Math.floor(Math.random() * 1000000000),
                sign: ''
            };
            
            // 计算签名
            apiParams.sign = CryptoJS.MD5(apiParams.appid + textToTranslate + apiParams.salt + "4xWe9UsRP2w9xByjpuHr").toString();
            
            // 构建API URL
            const apiUrl = `https://fanyi-api.baidu.com/api/trans/vip/translate?q=${encodeURIComponent(textToTranslate)}&from=${apiParams.from}&to=${apiParams.to}&appid=${apiParams.appid}&salt=${apiParams.salt}&sign=${apiParams.sign}`;
            
            // 使用代理服务器解决跨域问题
            const proxyUrl = PROXY_SERVERS[currentProxyIndex];
            let requestUrl = `${proxyUrl}${encodeURIComponent(apiUrl)}`;
            
            // 针对不同代理服务器的特殊处理
            if (proxyUrl.includes('allorigins.win')) {
                fetch(requestUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (!data.contents) throw new Error('未获取到翻译数据');
                        return JSON.parse(data.contents);
                    })
                    .then(handleTranslationResponse)
                    .catch(error => handleTranslationError(error));
            } else {
                fetch(requestUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
                        return response.json();
                    })
                    .then(handleTranslationResponse)
                    .catch(error => handleTranslationError(error));
            }
        }

        // 处理翻译响应
        function handleTranslationResponse(data) {
            if (data.error_code) {
                // 处理API返回的错误代码
                const errorMessages = {
                    '52001': '请求超时，请重试',
                    '52002': '系统错误，请重试',
                    '52003': '未授权用户，请检查appid是否正确',
                    '54000': '必填参数为空，请检查参数',
                    '54001': '签名错误，请检查签名生成方式',
                    '54003': '访问频率受限，请稍后再试',
                    '54004': '账户余额不足，请充值',
                    '54005': '长query请求频繁，请稍后再试',
                    '58000': '客户端IP非法，请检查ip是否在白名单中',
                    '58001': '语言不支持，请检查语言代码'
                };
                
                throw new Error(errorMessages[data.error_code] || `翻译失败: ${data.error_msg || '未知错误'}`);
            }
            
            let translatedText = data.trans_result.map(item => item.dst).join('\n');
            elements.resultText.textContent = translatedText;
            
            // 根据API返回结果更新语言检测
            if (data.from && translationState.from === 'auto') {
                translationState.from = data.from;
                updateLanguageDisplay(true);
            }
            
            showNotification('翻译完成');
            elements.loader.classList.add('hidden');
            elements.translateBtn.disabled = false;
        }

        // 处理翻译错误
        function handleTranslationError(error) {
            // 切换到下一个代理
            switchToNextProxy();
            
            let errorMessage = '';
            if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                errorMessage = '网络连接问题，已自动切换代理，请重试';
            } else if (error.message.includes('403')) {
                errorMessage = 'API权限不足，请检查密钥配置';
            } else if (error.message.includes('500')) {
                errorMessage = '服务器内部错误，请稍后再试';
            } else {
                errorMessage = error.message;
            }
            
            elements.resultText.innerHTML = `<div class="text-red-500 text-center py-5"><i class="fa fa-exclamation-circle mr-1"></i> 翻译失败</div>`;
            showError(errorMessage);
            showNotification(errorMessage, false);
            
            elements.loader.classList.add('hidden');
            elements.translateBtn.disabled = false;
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
